# AstrBot LetAI 智能表情包插件

让AI智能分析对话内容并发送合适表情包的AstrBot插件。基于深度情感分析和智能匹配算法，为你的聊天机器人增添生动有趣的表情包互动体验。

## ✨ 功能特点

### 🧠 智能情感分析
- **深度语义理解**：分析AI回复的情感倾向和内容主题
- **多维度匹配**：支持开心、可爱、惊讶、思考等多种情感类型
- **动态权重计算**：根据关键词密度和文本长度智能评分
- **随机性优化**：避免情感分析结果过于固定，增加表情包多样性

### 🎯 表情包选择策略
- **二次元优先**：专注于可爱动漫风格的表情包
- **主题精准匹配**：根据AI回复内容（如吃饭、睡觉、工作等）选择对应表情包
- **使用历史记录**：记录最近10个使用的表情包，避免短期重复
- **多样性保证**：30%概率强制下载新表情包，本地表情包不足时自动在线获取

### 📦 数据管理
- **智能缓存系统**：自动缓存表情包索引和本地文件
- **按需下载模式**：只下载需要使用的表情包，节省存储空间
- **分类存储**：按表情包类别自动整理到不同文件夹
- **多数据源支持**：网络JSON、本地文件、本地目录等多种数据源

### 🔧 灵活配置
- **发送概率控制**：可自定义AI发送表情包的概率(0.0-1.0)
- **上下文解析开关**：可选择是否启用智能内容分析
- **网络超时设置**：可配置网络请求超时时间
- **数据源切换**：支持多种表情包数据源

## 🚀 安装使用

### 快速开始
1. 将插件文件夹放入AstrBot的`plugins`目录
2. 重启AstrBot
3. 插件会自动开始工作，AI回复时有概率发送表情包

### 配置选项
在AstrBot配置文件中可以调整以下参数：

```json
{
  "enable_context_parsing": true,    // 是否启用智能表情包选择
  "send_probability": 0.3,           // 自动发送表情包的概率 (0.0-1.0)
  "request_timeout": 15,             // 网络请求超时时间(秒)
  "emoji_source": ""                 // 表情包数据源(留空使用默认)
}
```

## 📋 命令列表

插件提供以下命令供用户使用：

| 命令 | 功能 | 说明 |
|------|------|------|
| `测试表情包下载` | 测试下载功能 | 随机选择一个表情包进行下载测试 |
| `查看缓存信息` | 查看缓存状态 | 显示表情包缓存统计和下载信息 |
| `清理本地表情包` | 清理本地文件 | 删除所有已下载的表情包文件 |
| `查看使用历史` | 查看使用记录 | 显示最近使用的表情包历史 |
| `清空使用历史` | 清空使用记录 | 重置表情包使用历史 |
| `表情包统计` | 查看详细统计 | 显示表情包数量、下载率等详细信息 |

## 🔍 数据源配置

### 1. 默认配置（推荐）
```json
"emoji_source": ""
```
留空时优先使用已下载的缓存数据，没有缓存则自动使用ChineseBQB数据源。

### 2. 网络JSON地址
```json
"emoji_source": "https://raw.githubusercontent.com/zhaoolee/ChineseBQB/master/chinesebqb_github.json"
```
从网络加载表情包JSON数据，支持ChineseBQB格式或标准数组格式。

### 3. 本地JSON文件
```json
"emoji_source": "/path/to/your/emoji_data.json"
```
从本地JSON文件加载表情包索引。

### 4. 本地目录扫描
```json
"emoji_source": "/path/to/your/emoji/folder"
```
扫描本地目录中的图片文件(.jpg, .jpeg, .png, .gif, .webp)，自动生成表情包索引。

## 📊 JSON格式规范

### 标准格式
```json
[
  {
    "name": "开心笑脸.jpg",
    "category": "可爱的女孩纸",
    "url": "https://example.com/happy.jpg"
  },
  {
    "name": "思考中.gif",
    "category": "二次元",
    "url": "https://example.com/thinking.gif"
  }
]
```

### ChineseBQB格式
```json
{
  "data": [
    {
      "name": "表情包名称.jpg",
      "category": "分类名称",
      "url": "图片地址"
    }
  ]
}
```

### 字段说明
- `name`：表情包文件名（必需）
- `category`：分类名称（必需，用于智能匹配）
- `url`：网络图片地址（本地目录扫描时自动生成）
- `local_path`：本地文件路径（插件自动生成和管理）

## 📁 目录结构

插件运行后会在自己的目录下创建以下结构：

```
astrbot_plugin_LetAI_sendemojis/
├── main.py                         # 插件主文件
├── README.md                       # 说明文档
├── metadata.yaml                   # 插件元数据
├── _conf_schema.json              # 配置模式
└── emojis/                        # 表情包存储目录(自动创建)
    ├── emoji_cache.json           # 表情包索引缓存
    ├── 可爱的女孩纸👧BQB/          # 按分类存储
    │   ├── 开心笑脸.jpg
    │   ├── 害羞脸红.gif
    │   └── 可爱卖萌.png
    ├── 002CuteGirl_可爱系列/
    │   └── 萌萌哒.jpg
    └── 其他分类/
        └── 更多表情包...
```

## 🔧 工作原理

### 表情包选择流程
```
AI回复 → 情感分析 → 关键词提取 → 表情包匹配 → 多样性策略 → 发送表情包
   ↓         ↓          ↓           ↓           ↓
内容解析  情感分类   主题识别    优先级排序   历史过滤
```

### 智能下载策略
1. **优先本地**：首先搜索已下载的本地表情包
2. **历史过滤**：排除最近使用过的表情包
3. **强制多样性**：30%概率跳过本地搜索，直接下载新表情包
4. **智能触发**：本地可选表情包少于5个时自动在线下载
5. **避免重复**：在线搜索时排除已下载的表情包

### 情感分析算法
- **关键词匹配**：基于预定义的情感词典进行匹配
- **权重计算**：考虑关键词数量、权重系数和文本长度
- **多候选选择**：当多个情感得分相近时随机选择
- **智能回退**：无法识别时随机选择基础情感

## 🎮 使用示例

### 基础对话
```
用户: 今天心情好好啊！
AI: 太好了！看到你开心我也很高兴呢～
[插件自动分析"开心"情感，发送可爱笑脸表情包]
```

### 主题匹配
```
用户: 饿了想吃火锅
AI: 火锅听起来不错呢！记得要搭配蔬菜哦～
[插件识别"吃"主题，发送美食相关的表情包]
```

### 情感识别
```
用户: 今天工作好累...
AI: 辛苦了！要注意休息哦～
[插件识别"累"的情感，发送安慰或休息相关表情包]
```

## 🎨 自建表情包库

### 方法1：本地目录
创建如下结构的文件夹：
```
my_emojis/
├── 开心系列/
│   ├── 哈哈大笑.jpg
│   ├── 开心微笑.png
│   └── 兴奋激动.gif
├── 可爱系列/
│   ├── 软萌可爱.jpg
│   └── 害羞脸红.png
└── 日常系列/
    ├── 吃饭香香.gif
    └── 睡觉zzz.jpg
```
然后在配置中设置：`"emoji_source": "/path/to/my_emojis"`

### 方法2：JSON文件
创建自定义的JSON索引文件，参考上面的格式规范。可以包含网络图片链接，插件会自动下载。

### 方法3：扩展现有库
在默认的ChineseBQB基础上，通过本地目录或JSON文件补充更多表情包。

## ⚙️ 性能优化

### 存储优化
- **按需下载**：只下载实际使用的表情包
- **智能缓存**：自动管理表情包索引缓存
- **分类存储**：按类别组织文件，便于管理

### 网络优化
- **超时控制**：可配置网络请求超时时间
- **异步下载**：表情包下载不阻塞主要功能
- **失败重试**：网络失败时优雅降级

### 性能监控
使用`表情包统计`命令可以查看：
- 表情包总数量和下载情况
- 二次元表情包占比
- 使用历史记录状态
- 当前策略执行情况

## 🛠️ 故障排除

### 常见问题

**Q: 表情包不发送？**
A: 检查`enable_context_parsing`是否开启，`send_probability`是否大于0

**Q: 总是发送相同表情包？**
A: 使用`清空使用历史`命令重置，或检查本地表情包数量

**Q: 下载失败？**
A: 检查网络连接，或使用`测试表情包下载`命令诊断

**Q: 表情包不匹配？**
A: 表情包的`category`字段需要包含相关关键词，如"可爱"、"开心"等

### 调试命令
- `表情包统计`：查看整体状态
- `查看缓存信息`：检查缓存情况
- `测试表情包下载`：测试下载功能
- `查看使用历史`：检查使用记录

## 🙏 致谢

### 表情包数据来源
本插件默认使用 [ChineseBQB](https://github.com/zhaoolee/ChineseBQB) 项目提供的表情包数据。

**特别感谢：**
- **zhaoolee** - ChineseBQB项目作者，提供了丰富的中文表情包数据库
- **数据源地址**：https://raw.githubusercontent.com/zhaoolee/ChineseBQB/master/chinesebqb_github.json
- **项目主页**：https://github.com/zhaoolee/ChineseBQB

ChineseBQB是一个优质的中文表情包收集项目，包含了大量有趣、实用的表情包，为本插件提供了强大的数据支持。

### 开源协议
- 本插件遵循开源协议
- ChineseBQB项目请查看其项目许可证
- 表情包版权归原作者所有

## 📮 反馈与支持

如果您在使用过程中遇到问题或有建议，欢迎：
- 提交Issue反馈问题
- 提供新的表情包数据源
- 贡献代码改进功能
- 分享使用经验和技巧

让我们一起让聊天机器人变得更加生动有趣！

---

> 💡 **提示**：首次使用时插件会从网络下载表情包数据，请耐心等待。建议在网络良好的环境下进行初始化设置。